<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    canvas { background: #2d5a27; border: 4px solid #1a3a18; display: block; margin: 0 auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    body { background-color: #1a202c; color: white; overflow-x: hidden; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <div class="text-center mb-4">
    <h1 class="text-4xl font-bold text-yellow-500 mb-2">ğŸ¤  çµäºº vs ç†Š ğŸ»</h1>
    <p class="text-gray-400">åˆ†æ•¸: <span id="score" class="text-white text-2xl font-mono">0</span></p>
  </div>

  <canvas id="gameCanvas" width="400" height="500"></canvas>

  <div class="mt-6 space-x-4 text-center">
    <div class="flex gap-4 justify-center mb-4">
        <button id="startBtn" onclick="initGame()" class="bg-green-600 hover:bg-green-700 px-8 py-2 rounded-full font-bold transition-all">é–‹å§‹çµæ•</button>
        <button onclick="navToLeaderboard()" class="bg-blue-600 hover:bg-blue-700 px-8 py-2 rounded-full font-bold transition-all">æ’è¡Œæ¦œ (Read)</button>
    </div>
    <p class="text-xs text-gray-500">æ§åˆ¶æ–¹å¼ï¼šå·¦å³æ–¹å‘éµç§»å‹•ï¼Œç©ºç™½éµæˆ–ä¸Šæ–¹å‘éµç™¼å°„å­å½ˆ</p>
  </div>

  <!-- éŠæˆ²çµæŸå°è©±æ¡† -->
  <div id="saveModal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50">
    <div class="bg-white text-gray-900 p-8 rounded-xl max-w-sm w-full">
      <h2 class="text-2xl font-bold mb-2 text-center text-red-600">ç‹©çµçµæŸï¼</h2>
      <p class="mb-4 text-center">ä½ çš„åˆ†æ•¸ï¼š<span id="finalScore" class="font-bold text-green-600 text-xl"></span></p>
      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-600 mb-1">çµäººä»£è™Ÿï¼š</label>
        <input type="text" id="playerName" placeholder="ä¾‹å¦‚ï¼šæœ€å¼·çµäºº" class="w-full border-2 border-gray-300 p-2 rounded focus:border-green-500 outline-none">
      </div>
      <button onclick="submitScore()" id="submitBtn" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 transition">ä¸Šå‚³åˆ†æ•¸ (Create)</button>
      <button onclick="document.getElementById('saveModal').classList.add('hidden')" class="w-full mt-2 text-gray-400 text-sm py-1">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let gameActive = false;
    let score = 0;
    let hunterX = 200;
    let bullets = [];
    let bears = [];
    let bearSpeed = 2;
    let frame = 0;
    let lastFireFrame = 0; // ç”¨æ–¼æ§åˆ¶ç™¼å°„é€Ÿç‡çš„å†·å»æ™‚é–“

    // éµç›¤ç›£è½
    let keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function initGame() {
      if (gameActive) return;
      score = 0;
      bearSpeed = 2;
      bullets = [];
      bears = [];
      hunterX = 200;
      frame = 0;
      lastFireFrame = 0;
      gameActive = true;
      document.getElementById('startBtn').innerText = "é€²è¡Œä¸­...";
      document.getElementById('startBtn').disabled = true;
      document.getElementById('score').innerText = "0";
      document.getElementById('saveModal').classList.add('hidden');
      loop();
    }

    function loop() {
      if (!gameActive) return;
      update();
      draw();
      frame++;
      requestAnimationFrame(loop);
    }

    function update() {
      // 1. çµäººå·¦å³ç§»å‹•
      if (keys['ArrowLeft'] && hunterX > 25) hunterX -= 6;
      if (keys['ArrowRight'] && hunterX < 375) hunterX += 6;
      
      // 2. æ‰‹å‹•ç™¼å°„å­å½ˆ (ä¿®æ”¹é»ï¼šæ”¹ç‚ºåµæ¸¬éµç›¤ä¸”åŠ å…¥å†·å»æ™‚é–“)
      // æ¯ 12 å¹€ (ç´„ 0.2 ç§’) æ‰èƒ½ç™¼å°„ä¸€æ¬¡ï¼Œé˜²æ­¢å­å½ˆé€£æˆä¸€ç·š
      if ((keys['Space'] || keys['ArrowUp']) && (frame - lastFireFrame > 12)) {
        bullets.push({ x: hunterX, y: 440 });
        lastFireFrame = frame;
      }

      // 3. å­å½ˆç§»å‹•é‚è¼¯
      for (let i = bullets.length - 1; i >= 0; i--) {
        bullets[i].y -= 8;
        if (bullets[i].y < 0) bullets.splice(i, 1);
      }

      // 4. ç†Šçš„ç”Ÿæˆé‚è¼¯ (éš¨é›£åº¦å¢åŠ )
      let spawnRate = Math.max(12, 45 - Math.floor(score / 60));
      if (frame % spawnRate === 0) {
        bears.push({ 
          x: Math.random() * 340 + 30, 
          y: -30,
          speed: 2 + (score / 300) // ç†Šçš„é€Ÿåº¦éš¨åˆ†æ•¸ç·©æ…¢å¢åŠ 
        });
      }

      // 5. ç†Šçš„ç§»å‹•èˆ‡ç¢°æ’æª¢æ¸¬
      for (let bi = bears.length - 1; bi >= 0; bi--) {
        let bear = bears[bi];
        bear.y += bear.speed;
        
        // å¤±æ•—æ¢ä»¶ï¼šç†Šè¶Šéåº•ç·š æˆ– ç¢°åˆ°çµäºº
        if (bear.y > 500 || (Math.abs(bear.x - hunterX) < 25 && bear.y > 440)) {
          gameOver();
          return;
        }

        // å­å½ˆç¢°æ’æª¢æŸ¥
        for (let ui = bullets.length - 1; ui >= 0; ui--) {
          let bullet = bullets[ui];
          // ä½¿ç”¨ç°¡å–®çš„åœ“å½¢/çŸ©å½¢è·é›¢æª¢æ¸¬
          let dist = Math.hypot(bullet.x - bear.x, bullet.y - bear.y);
          if (dist < 25) {
            bears.splice(bi, 1);
            bullets.splice(ui, 1);
            score += 10;
            document.getElementById('score').innerText = score;
            break; // é€™éš»ç†Šå·²ç¶“è¢«æ‰“æ‰ï¼Œè·³å‡ºå­å½ˆè¿´åœˆ
          }
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, 400, 500);
      
      // ç¹ªè£½èƒŒæ™¯è£é£¾ (ç°¡æ˜“è‰åœ°è³ªæ„Ÿ)
      ctx.fillStyle = "#254d20";
      for(let i=0; i<10; i++) ctx.fillRect(i*50, (frame%100), 2, 20);

      // ç¹ªè£½çµäºº ğŸ¤ 
      ctx.font = "32px serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ğŸ¤ ", hunterX, 465);

      // ç¹ªè£½å­å½ˆ (é»ƒè‰²å…‰é»)
      ctx.fillStyle = "#fbbf24";
      bullets.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
        ctx.fill();
        // å­å½ˆå…‰æšˆ
        ctx.shadowBlur = 10;
        ctx.shadowColor = "yellow";
      });
      ctx.shadowBlur = 0; // é‡ç½®å…‰æšˆ

      // ç¹ªè£½ç†Š ğŸ»
      ctx.font = "30px serif";
      bears.forEach(bear => {
        ctx.fillText("ğŸ»", bear.x, bear.y);
      });
    }

    function gameOver() {
      gameActive = false;
      document.getElementById('finalScore').innerText = score;
      document.getElementById('saveModal').classList.remove('hidden');
      document.getElementById('startBtn').innerText = "é‡æ–°é–‹å§‹";
      document.getElementById('startBtn').disabled = false;
    }

    function submitScore() {
      const name = document.getElementById('playerName').value || "ç„¡åçµäºº";
      const btn = document.getElementById('submitBtn');
      
      if (name.trim() === "") return alert("è«‹è¼¸å…¥ä»£è™Ÿï¼");

      btn.disabled = true;
      btn.innerText = "å‚³é€ä¸­...";

      google.script.run
        .withSuccessHandler(res => {
          alert(res.message);
          document.getElementById('saveModal').classList.add('hidden');
          btn.disabled = false;
          btn.innerText = "ä¸Šå‚³åˆ†æ•¸ (Create)";
          document.getElementById('playerName').value = "";
        })
        .withFailureHandler(err => {
          alert("å„²å­˜å¤±æ•—ï¼š" + err);
          btn.disabled = false;
          btn.innerText = "ä¸Šå‚³åˆ†æ•¸ (Create)";
        })
        .createScore(name, score);
    }

    function navToLeaderboard() {
      google.script.run
        .withSuccessHandler(url => {
          window.open(url + "?page=leaderboard", "_top");
        })
        .getScriptUrl();
    }
  </script>
</body>
</html>
